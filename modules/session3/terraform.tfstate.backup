{
  "version": 4,
  "terraform_version": "1.0.9",
  "serial": 22,
  "lineage": "79702475-57a8-6e1e-fa9e-f04574b94b73",
  "outputs": {
    "clients": {
      "value": [
        [
          "54.86.181.107"
        ]
      ],
      "type": [
        "tuple",
        [
          [
            "tuple",
            [
              "string"
            ]
          ]
        ]
      ]
    },
    "promcol": {
      "value": [
        "44.201.223.168"
      ],
      "type": [
        "tuple",
        [
          "string"
        ]
      ]
    },
    "servers": {
      "value": [
        [
          "52.205.252.79",
          "18.207.248.124",
          "54.175.208.63"
        ]
      ],
      "type": [
        "tuple",
        [
          [
            "tuple",
            [
              "string",
              "string",
              "string"
            ]
          ]
        ]
      ]
    }
  },
  "resources": [
    {
      "mode": "data",
      "type": "template_cloudinit_config",
      "name": "consul_client",
      "provider": "provider[\"registry.terraform.io/hashicorp/template\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "base64_encode": true,
            "gzip": true,
            "id": "2868144419",
            "part": [
              {
                "content": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n         \"node_name\": \"opsschool-client-1\",\r\n       \"enable_script_checks\": true,\r\n       \"server\": false\r\n\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v0.18.1/node_exporter-0.18.1.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p /opt/prometheus\r\ntar zxf /tmp/node_exporter.tgz -C /opt/prometheus\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=/opt/prometheus/node_exporter-0.18.1.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
                "content_type": "",
                "filename": "",
                "merge_type": ""
              },
              {
                "content": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install apache2\r\n\r\ntee /etc/consul.d/webserver-80.json \u003e /dev/null \u003c\u003c\"EOF\"\r\n{\r\n  \"service\": {\r\n    \"id\": \"webserver-80\",\r\n    \"name\": \"webserver\",\r\n    \"tags\": [\"apache\"],\r\n    \"port\": 80,\r\n    \"checks\": [\r\n      {\r\n        \"id\": \"tcp\",\r\n        \"name\": \"TCP on port 80\",\r\n        \"tcp\": \"localhost:80\",\r\n        \"interval\": \"10s\",\r\n        \"timeout\": \"1s\"\r\n      },\r\n      {\r\n        \"id\": \"http\",\r\n        \"name\": \"HTTP on port 80\",\r\n        \"http\": \"http://localhost:80/\",\r\n        \"interval\": \"30s\",\r\n        \"timeout\": \"1s\"\r\n      },\r\n      {\r\n        \"id\": \"service\",\r\n        \"name\": \"apache service\",\r\n        \"args\": [\"systemctl\", \"status\", \"apache2.service\"],\r\n        \"interval\": \"60s\"\r\n      }\r\n    ]\r\n  }\r\n}\r\nEOF\r\n\r\nconsul reload\r\n\r\n### Install apache Exporter\r\nwget https://github.com/Lusitaniae/apache_exporter/releases/download/v0.7.0/apache_exporter-0.7.0.linux-amd64.tar.gz -O /tmp/apache_exporter.tgz\r\nmkdir -p /opt/prometheus\r\ntar zxf /tmp/apache_exporter.tgz -C /opt/prometheus\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/apache_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus apache exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=/opt/prometheus/apache_exporter-0.7.0.linux-amd64/apache_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable apache_exporter.service\r\nsystemctl start apache_exporter.service\r\n\r\n",
                "content_type": "",
                "filename": "",
                "merge_type": ""
              }
            ],
            "rendered": "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"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "mode": "data",
      "type": "template_cloudinit_config",
      "name": "promcol",
      "provider": "provider[\"registry.terraform.io/hashicorp/template\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "base64_encode": true,
            "gzip": true,
            "id": "3321760245",
            "part": [
              {
                "content": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n         \"node_name\": \"promcol\",\r\n       \"enable_script_checks\": true,\r\n       \"server\": false\r\n\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v0.18.1/node_exporter-0.18.1.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p /opt/prometheus\r\ntar zxf /tmp/node_exporter.tgz -C /opt/prometheus\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=/opt/prometheus/node_exporter-0.18.1.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
                "content_type": "",
                "filename": "",
                "merge_type": ""
              },
              {
                "content": "#!/usr/bin/env bash\r\nset -e\r\n\r\n### Install Prometheus Collector\r\nwget https://github.com/prometheus/prometheus/releases/download/v2.16.0/prometheus-2.16.0.linux-amd64.tar.gz -O /tmp/promcoll.tgz\r\nmkdir -p /opt/prometheus\r\ntar zxf /tmp/promcoll.tgz -C /opt/prometheus\r\n\r\n# Create promcol configuration\r\nmkdir -p /etc/prometheus\r\ntee /etc/prometheus/prometheus.yml \u003e /dev/null \u003c\u003cEOF\r\nscrape_configs:\r\n  - job_name: 'prometheus'\r\n    static_configs:\r\n    - targets: ['localhost:9090']\r\nEOF\r\n\r\n# Configure promcol service\r\ntee /etc/systemd/system/promcol.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus Collector\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=/opt/prometheus/prometheus-2.16.0.linux-amd64/prometheus --config.file=/etc/prometheus/prometheus.yml\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable promcol.service\r\nsystemctl start promcol.service\r\n\r\n### add promcol service to consul\r\ntee /etc/consul.d/promcol-9090.json \u003e /dev/null \u003c\u003c\"EOF\"\r\n{\r\n  \"service\": {\r\n    \"id\": \"promcol-9090\",\r\n    \"name\": \"promcol\",\r\n    \"tags\": [\"promcol\"],\r\n    \"port\": 9090,\r\n    \"checks\": [\r\n      {\r\n        \"id\": \"tcp\",\r\n        \"name\": \"TCP on port 9090\",\r\n        \"tcp\": \"localhost:9090\",\r\n        \"interval\": \"10s\",\r\n        \"timeout\": \"1s\"\r\n      }\r\n    ]\r\n  }\r\n}\r\nEOF\r\n\r\nconsul reload\r\n",
                "content_type": "",
                "filename": "",
                "merge_type": ""
              }
            ],
            "rendered": "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"
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "mode": "data",
      "type": "template_file",
      "name": "consul_client",
      "provider": "provider[\"registry.terraform.io/hashicorp/template\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "filename": null,
            "id": "fb6e6c5c39c4d5eaf3c76ad7fe3afa705c8ac22e2892a19a04c861c737e9aad7",
            "rendered": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n         \"node_name\": \"opsschool-client-1\",\r\n       \"enable_script_checks\": true,\r\n       \"server\": false\r\n\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v0.18.1/node_exporter-0.18.1.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p /opt/prometheus\r\ntar zxf /tmp/node_exporter.tgz -C /opt/prometheus\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=/opt/prometheus/node_exporter-0.18.1.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
            "template": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n  ${config}\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v${node_exporter_version}/node_exporter-${node_exporter_version}.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p ${prometheus_dir}\r\ntar zxf /tmp/node_exporter.tgz -C ${prometheus_dir}\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=${prometheus_dir}/node_exporter-${node_exporter_version}.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
            "vars": {
              "config": "       \"node_name\": \"opsschool-client-1\",\r\n       \"enable_script_checks\": true,\r\n       \"server\": false\r\n",
              "consul_version": "1.4.0",
              "node_exporter_version": "0.18.1",
              "prometheus_dir": "/opt/prometheus"
            }
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "mode": "data",
      "type": "template_file",
      "name": "consul_promcol",
      "provider": "provider[\"registry.terraform.io/hashicorp/template\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "filename": null,
            "id": "ab967d15e2094bf698c19460e492dd54f491d09f1c27d56905241b57bacc644f",
            "rendered": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n         \"node_name\": \"promcol\",\r\n       \"enable_script_checks\": true,\r\n       \"server\": false\r\n\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v0.18.1/node_exporter-0.18.1.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p /opt/prometheus\r\ntar zxf /tmp/node_exporter.tgz -C /opt/prometheus\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=/opt/prometheus/node_exporter-0.18.1.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
            "template": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n  ${config}\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v${node_exporter_version}/node_exporter-${node_exporter_version}.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p ${prometheus_dir}\r\ntar zxf /tmp/node_exporter.tgz -C ${prometheus_dir}\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=${prometheus_dir}/node_exporter-${node_exporter_version}.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
            "vars": {
              "config": "       \"node_name\": \"promcol\",\r\n       \"enable_script_checks\": true,\r\n       \"server\": false\r\n",
              "consul_version": "1.4.0",
              "node_exporter_version": "0.18.1",
              "prometheus_dir": "/opt/prometheus"
            }
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "mode": "data",
      "type": "template_file",
      "name": "consul_server",
      "provider": "provider[\"registry.terraform.io/hashicorp/template\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "filename": null,
            "id": "49d98d1e216ee501d0315c7eddc694ca0075f7a6d9e70d069df8ca56210ec458",
            "rendered": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n    \"node_name\": \"opsschool-server-1\",\r\n  \"server\": true,\r\n  \"bootstrap_expect\": 3,\r\n  \"ui\": true,\r\n  \"client_addr\": \"0.0.0.0\",\r\n  \"telemetry\": {\r\n    \"prometheus_retention_time\": \"10m\"\r\n  }\r\n\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v0.18.1/node_exporter-0.18.1.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p /opt/prometheus\r\ntar zxf /tmp/node_exporter.tgz -C /opt/prometheus\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=/opt/prometheus/node_exporter-0.18.1.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
            "template": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n  ${config}\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v${node_exporter_version}/node_exporter-${node_exporter_version}.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p ${prometheus_dir}\r\ntar zxf /tmp/node_exporter.tgz -C ${prometheus_dir}\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=${prometheus_dir}/node_exporter-${node_exporter_version}.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
            "vars": {
              "config": "  \"node_name\": \"opsschool-server-1\",\r\n  \"server\": true,\r\n  \"bootstrap_expect\": 3,\r\n  \"ui\": true,\r\n  \"client_addr\": \"0.0.0.0\",\r\n  \"telemetry\": {\r\n    \"prometheus_retention_time\": \"10m\"\r\n  }\r\n",
              "consul_version": "1.4.0",
              "node_exporter_version": "0.18.1",
              "prometheus_dir": "/opt/prometheus"
            }
          },
          "sensitive_attributes": []
        },
        {
          "index_key": 1,
          "schema_version": 0,
          "attributes": {
            "filename": null,
            "id": "be6417a7e15297b94c5cea0e008f7521b86a24bfb1783fd31a7617980acbd48e",
            "rendered": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n    \"node_name\": \"opsschool-server-2\",\r\n  \"server\": true,\r\n  \"bootstrap_expect\": 3,\r\n  \"ui\": true,\r\n  \"client_addr\": \"0.0.0.0\",\r\n  \"telemetry\": {\r\n    \"prometheus_retention_time\": \"10m\"\r\n  }\r\n\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v0.18.1/node_exporter-0.18.1.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p /opt/prometheus\r\ntar zxf /tmp/node_exporter.tgz -C /opt/prometheus\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=/opt/prometheus/node_exporter-0.18.1.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
            "template": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n  ${config}\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v${node_exporter_version}/node_exporter-${node_exporter_version}.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p ${prometheus_dir}\r\ntar zxf /tmp/node_exporter.tgz -C ${prometheus_dir}\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=${prometheus_dir}/node_exporter-${node_exporter_version}.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
            "vars": {
              "config": "  \"node_name\": \"opsschool-server-2\",\r\n  \"server\": true,\r\n  \"bootstrap_expect\": 3,\r\n  \"ui\": true,\r\n  \"client_addr\": \"0.0.0.0\",\r\n  \"telemetry\": {\r\n    \"prometheus_retention_time\": \"10m\"\r\n  }\r\n",
              "consul_version": "1.4.0",
              "node_exporter_version": "0.18.1",
              "prometheus_dir": "/opt/prometheus"
            }
          },
          "sensitive_attributes": []
        },
        {
          "index_key": 2,
          "schema_version": 0,
          "attributes": {
            "filename": null,
            "id": "230581d31902e68761a90c9b64adca0d0f884baf18154ba458559259c6f88a88",
            "rendered": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/1.4.0/consul_1.4.0_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n    \"node_name\": \"opsschool-server-3\",\r\n  \"server\": true,\r\n  \"bootstrap_expect\": 3,\r\n  \"ui\": true,\r\n  \"client_addr\": \"0.0.0.0\",\r\n  \"telemetry\": {\r\n    \"prometheus_retention_time\": \"10m\"\r\n  }\r\n\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v0.18.1/node_exporter-0.18.1.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p /opt/prometheus\r\ntar zxf /tmp/node_exporter.tgz -C /opt/prometheus\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=/opt/prometheus/node_exporter-0.18.1.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
            "template": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Grabbing IPs...\"\r\nPRIVATE_IP=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install unzip dnsmasq\r\n\r\necho \"Configuring dnsmasq...\"\r\ncat \u003c\u003c EODMCF \u003e/etc/dnsmasq.d/10-consul\r\n# Enable forward lookup of the 'consul' domain:\r\nserver=/consul/127.0.0.1#8600\r\nEODMCF\r\n\r\nsystemctl restart dnsmasq\r\n\r\ncat \u003c\u003c EOF \u003e/etc/systemd/resolved.conf\r\n[Resolve]\r\nDNS=127.0.0.1\r\nDomains=~consul\r\nEOF\r\n\r\nsystemctl restart systemd-resolved.service\r\n\r\necho \"Fetching Consul...\"\r\ncd /tmp\r\ncurl -sLo consul.zip https://releases.hashicorp.com/consul/${consul_version}/consul_${consul_version}_linux_amd64.zip\r\n\r\necho \"Installing Consul...\"\r\nunzip consul.zip \u003e/dev/null\r\nchmod +x consul\r\nmv consul /usr/local/bin/consul\r\n\r\n# Setup Consul\r\nmkdir -p /opt/consul\r\nmkdir -p /etc/consul.d\r\nmkdir -p /run/consul\r\ntee /etc/consul.d/config.json \u003e /dev/null \u003c\u003cEOF\r\n{\r\n  \"advertise_addr\": \"$PRIVATE_IP\",\r\n  \"data_dir\": \"/opt/consul\",\r\n  \"datacenter\": \"opsschool\",\r\n  \"encrypt\": \"uDBV4e+LbFW3019YKPxIrg==\",\r\n  \"disable_remote_exec\": true,\r\n  \"disable_update_check\": true,\r\n  \"leave_on_terminate\": true,\r\n  \"retry_join\": [\"provider=aws tag_key=consul_server tag_value=true\"],\r\n  ${config}\r\n}\r\nEOF\r\n\r\n# Create user \u0026 grant ownership of folders\r\nuseradd consul\r\nchown -R consul:consul /opt/consul /etc/consul.d /run/consul\r\n\r\n\r\n# Configure consul service\r\ntee /etc/systemd/system/consul.service \u003e /dev/null \u003c\u003c\"EOF\"\r\n[Unit]\r\nDescription=Consul service discovery agent\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nUser=consul\r\nGroup=consul\r\nPIDFile=/run/consul/consul.pid\r\nRestart=on-failure\r\nEnvironment=GOMAXPROCS=2\r\nExecStart=/usr/local/bin/consul agent -pid-file=/run/consul/consul.pid -config-dir=/etc/consul.d\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable consul.service\r\nsystemctl start consul.service\r\n\r\n\r\n### Install Node Exporter\r\nwget https://github.com/prometheus/node_exporter/releases/download/v${node_exporter_version}/node_exporter-${node_exporter_version}.linux-amd64.tar.gz -O /tmp/node_exporter.tgz\r\nmkdir -p ${prometheus_dir}\r\ntar zxf /tmp/node_exporter.tgz -C ${prometheus_dir}\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/node_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus node exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=${prometheus_dir}/node_exporter-${node_exporter_version}.linux-amd64/node_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable node_exporter.service\r\nsystemctl start node_exporter.service\r\n",
            "vars": {
              "config": "  \"node_name\": \"opsschool-server-3\",\r\n  \"server\": true,\r\n  \"bootstrap_expect\": 3,\r\n  \"ui\": true,\r\n  \"client_addr\": \"0.0.0.0\",\r\n  \"telemetry\": {\r\n    \"prometheus_retention_time\": \"10m\"\r\n  }\r\n",
              "consul_version": "1.4.0",
              "node_exporter_version": "0.18.1",
              "prometheus_dir": "/opt/prometheus"
            }
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "mode": "data",
      "type": "template_file",
      "name": "promcol",
      "provider": "provider[\"registry.terraform.io/hashicorp/template\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "filename": null,
            "id": "eddf2a9e01ee0df217de8f9a2192882baf70d7a824a0045e950ac0261c6ea725",
            "rendered": "#!/usr/bin/env bash\r\nset -e\r\n\r\n### Install Prometheus Collector\r\nwget https://github.com/prometheus/prometheus/releases/download/v2.16.0/prometheus-2.16.0.linux-amd64.tar.gz -O /tmp/promcoll.tgz\r\nmkdir -p /opt/prometheus\r\ntar zxf /tmp/promcoll.tgz -C /opt/prometheus\r\n\r\n# Create promcol configuration\r\nmkdir -p /etc/prometheus\r\ntee /etc/prometheus/prometheus.yml \u003e /dev/null \u003c\u003cEOF\r\nscrape_configs:\r\n  - job_name: 'prometheus'\r\n    static_configs:\r\n    - targets: ['localhost:9090']\r\nEOF\r\n\r\n# Configure promcol service\r\ntee /etc/systemd/system/promcol.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus Collector\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=/opt/prometheus/prometheus-2.16.0.linux-amd64/prometheus --config.file=/etc/prometheus/prometheus.yml\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable promcol.service\r\nsystemctl start promcol.service\r\n\r\n### add promcol service to consul\r\ntee /etc/consul.d/promcol-9090.json \u003e /dev/null \u003c\u003c\"EOF\"\r\n{\r\n  \"service\": {\r\n    \"id\": \"promcol-9090\",\r\n    \"name\": \"promcol\",\r\n    \"tags\": [\"promcol\"],\r\n    \"port\": 9090,\r\n    \"checks\": [\r\n      {\r\n        \"id\": \"tcp\",\r\n        \"name\": \"TCP on port 9090\",\r\n        \"tcp\": \"localhost:9090\",\r\n        \"interval\": \"10s\",\r\n        \"timeout\": \"1s\"\r\n      }\r\n    ]\r\n  }\r\n}\r\nEOF\r\n\r\nconsul reload\r\n",
            "template": "#!/usr/bin/env bash\r\nset -e\r\n\r\n### Install Prometheus Collector\r\nwget https://github.com/prometheus/prometheus/releases/download/v${promcol_version}/prometheus-${promcol_version}.linux-amd64.tar.gz -O /tmp/promcoll.tgz\r\nmkdir -p ${prometheus_dir}\r\ntar zxf /tmp/promcoll.tgz -C ${prometheus_dir}\r\n\r\n# Create promcol configuration\r\nmkdir -p ${prometheus_conf_dir}\r\ntee ${prometheus_conf_dir}/prometheus.yml \u003e /dev/null \u003c\u003cEOF\r\nscrape_configs:\r\n  - job_name: 'prometheus'\r\n    static_configs:\r\n    - targets: ['localhost:9090']\r\nEOF\r\n\r\n# Configure promcol service\r\ntee /etc/systemd/system/promcol.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus Collector\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=${prometheus_dir}/prometheus-${promcol_version}.linux-amd64/prometheus --config.file=${prometheus_conf_dir}/prometheus.yml\r\nExecReload=/bin/kill -s HUP \\$MAINPID\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable promcol.service\r\nsystemctl start promcol.service\r\n\r\n### add promcol service to consul\r\ntee /etc/consul.d/promcol-9090.json \u003e /dev/null \u003c\u003c\"EOF\"\r\n{\r\n  \"service\": {\r\n    \"id\": \"promcol-9090\",\r\n    \"name\": \"promcol\",\r\n    \"tags\": [\"promcol\"],\r\n    \"port\": 9090,\r\n    \"checks\": [\r\n      {\r\n        \"id\": \"tcp\",\r\n        \"name\": \"TCP on port 9090\",\r\n        \"tcp\": \"localhost:9090\",\r\n        \"interval\": \"10s\",\r\n        \"timeout\": \"1s\"\r\n      }\r\n    ]\r\n  }\r\n}\r\nEOF\r\n\r\nconsul reload\r\n",
            "vars": {
              "promcol_version": "2.16.0",
              "prometheus_conf_dir": "/etc/prometheus",
              "prometheus_dir": "/opt/prometheus"
            }
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "mode": "data",
      "type": "template_file",
      "name": "webserver",
      "provider": "provider[\"registry.terraform.io/hashicorp/template\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 0,
          "attributes": {
            "filename": null,
            "id": "9657c98273b3bd61c8188d30717e0c78bb5ea515e7afc1da3d20807f68ef6de6",
            "rendered": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install apache2\r\n\r\ntee /etc/consul.d/webserver-80.json \u003e /dev/null \u003c\u003c\"EOF\"\r\n{\r\n  \"service\": {\r\n    \"id\": \"webserver-80\",\r\n    \"name\": \"webserver\",\r\n    \"tags\": [\"apache\"],\r\n    \"port\": 80,\r\n    \"checks\": [\r\n      {\r\n        \"id\": \"tcp\",\r\n        \"name\": \"TCP on port 80\",\r\n        \"tcp\": \"localhost:80\",\r\n        \"interval\": \"10s\",\r\n        \"timeout\": \"1s\"\r\n      },\r\n      {\r\n        \"id\": \"http\",\r\n        \"name\": \"HTTP on port 80\",\r\n        \"http\": \"http://localhost:80/\",\r\n        \"interval\": \"30s\",\r\n        \"timeout\": \"1s\"\r\n      },\r\n      {\r\n        \"id\": \"service\",\r\n        \"name\": \"apache service\",\r\n        \"args\": [\"systemctl\", \"status\", \"apache2.service\"],\r\n        \"interval\": \"60s\"\r\n      }\r\n    ]\r\n  }\r\n}\r\nEOF\r\n\r\nconsul reload\r\n\r\n### Install apache Exporter\r\nwget https://github.com/Lusitaniae/apache_exporter/releases/download/v0.7.0/apache_exporter-0.7.0.linux-amd64.tar.gz -O /tmp/apache_exporter.tgz\r\nmkdir -p /opt/prometheus\r\ntar zxf /tmp/apache_exporter.tgz -C /opt/prometheus\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/apache_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus apache exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=/opt/prometheus/apache_exporter-0.7.0.linux-amd64/apache_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable apache_exporter.service\r\nsystemctl start apache_exporter.service\r\n\r\n",
            "template": "#!/usr/bin/env bash\r\nset -e\r\n\r\necho \"Installing dependencies...\"\r\napt-get -q update\r\napt-get -yq install apache2\r\n\r\ntee /etc/consul.d/webserver-80.json \u003e /dev/null \u003c\u003c\"EOF\"\r\n{\r\n  \"service\": {\r\n    \"id\": \"webserver-80\",\r\n    \"name\": \"webserver\",\r\n    \"tags\": [\"apache\"],\r\n    \"port\": 80,\r\n    \"checks\": [\r\n      {\r\n        \"id\": \"tcp\",\r\n        \"name\": \"TCP on port 80\",\r\n        \"tcp\": \"localhost:80\",\r\n        \"interval\": \"10s\",\r\n        \"timeout\": \"1s\"\r\n      },\r\n      {\r\n        \"id\": \"http\",\r\n        \"name\": \"HTTP on port 80\",\r\n        \"http\": \"http://localhost:80/\",\r\n        \"interval\": \"30s\",\r\n        \"timeout\": \"1s\"\r\n      },\r\n      {\r\n        \"id\": \"service\",\r\n        \"name\": \"apache service\",\r\n        \"args\": [\"systemctl\", \"status\", \"apache2.service\"],\r\n        \"interval\": \"60s\"\r\n      }\r\n    ]\r\n  }\r\n}\r\nEOF\r\n\r\nconsul reload\r\n\r\n### Install apache Exporter\r\nwget https://github.com/Lusitaniae/apache_exporter/releases/download/v${apache_exporter_version}/apache_exporter-${apache_exporter_version}.linux-amd64.tar.gz -O /tmp/apache_exporter.tgz\r\nmkdir -p ${prometheus_dir}\r\ntar zxf /tmp/apache_exporter.tgz -C ${prometheus_dir}\r\n\r\n# Configure node exporter service\r\ntee /etc/systemd/system/apache_exporter.service \u003e /dev/null \u003c\u003cEOF\r\n[Unit]\r\nDescription=Prometheus apache exporter\r\nRequires=network-online.target\r\nAfter=network.target\r\n\r\n[Service]\r\nExecStart=${prometheus_dir}/apache_exporter-${apache_exporter_version}.linux-amd64/apache_exporter\r\nKillSignal=SIGINT\r\nTimeoutStopSec=5\r\n\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsystemctl daemon-reload\r\nsystemctl enable apache_exporter.service\r\nsystemctl start apache_exporter.service\r\n\r\n",
            "vars": {
              "apache_exporter_version": "0.7.0",
              "prometheus_dir": "/opt/prometheus"
            }
          },
          "sensitive_attributes": []
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_iam_instance_profile",
      "name": "consul-join",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "arn": "arn:aws:iam::727940474452:instance-profile/opsschool-consul-join",
            "create_date": "2022-02-15T18:33:39Z",
            "id": "opsschool-consul-join",
            "name": "opsschool-consul-join",
            "name_prefix": null,
            "path": "/",
            "role": "opsschool-consul-join",
            "tags": {},
            "tags_all": {},
            "unique_id": "AIPA2S7FCEZKE4IEHD6YE"
          },
          "sensitive_attributes": [],
          "private": "bnVsbA==",
          "dependencies": [
            "aws_iam_role.consul-join"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_iam_policy",
      "name": "consul-join",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "arn": "arn:aws:iam::727940474452:policy/opsschool-consul-join2",
            "description": "Allows Consul nodes to describe instances for joining.",
            "id": "arn:aws:iam::727940474452:policy/opsschool-consul-join2",
            "name": "opsschool-consul-join2",
            "name_prefix": null,
            "path": "/",
            "policy": "{\"Statement\":[{\"Action\":\"ec2:DescribeInstances\",\"Effect\":\"Allow\",\"Resource\":\"*\"}],\"Version\":\"2012-10-17\"}",
            "policy_id": "ANPA2S7FCEZKJOTXOGIQK",
            "tags": null,
            "tags_all": {}
          },
          "sensitive_attributes": [],
          "private": "bnVsbA=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_iam_policy_attachment",
      "name": "consul-join",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "groups": null,
            "id": "opsschool-consul-join",
            "name": "opsschool-consul-join",
            "policy_arn": "arn:aws:iam::727940474452:policy/opsschool-consul-join2",
            "roles": [
              "opsschool-consul-join"
            ],
            "users": null
          },
          "sensitive_attributes": [],
          "private": "bnVsbA==",
          "dependencies": [
            "aws_iam_policy.consul-join",
            "aws_iam_role.consul-join"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_iam_role",
      "name": "consul-join",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "arn": "arn:aws:iam::727940474452:role/opsschool-consul-join",
            "assume_role_policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Sid\":\"\",\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"ec2.amazonaws.com\"},\"Action\":\"sts:AssumeRole\"}]}",
            "create_date": "2022-02-15T18:33:36Z",
            "description": "",
            "force_detach_policies": false,
            "id": "opsschool-consul-join",
            "inline_policy": [
              {
                "name": "",
                "policy": ""
              }
            ],
            "managed_policy_arns": [
              "arn:aws:iam::727940474452:policy/opsschool-consul-join"
            ],
            "max_session_duration": 3600,
            "name": "opsschool-consul-join",
            "name_prefix": "",
            "path": "/",
            "permissions_boundary": null,
            "tags": {},
            "tags_all": {},
            "unique_id": "AROA2S7FCEZKGH4JXMHXT"
          },
          "sensitive_attributes": [],
          "private": "bnVsbA=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_instance",
      "name": "consul_client",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 1,
          "attributes": {
            "ami": "ami-04b9e92b5572fa0d1",
            "arn": "arn:aws:ec2:us-east-1:727940474452:instance/i-0294697b600f3ff41",
            "associate_public_ip_address": true,
            "availability_zone": "us-east-1b",
            "capacity_reservation_specification": [
              {
                "capacity_reservation_preference": "open",
                "capacity_reservation_target": []
              }
            ],
            "cpu_core_count": 1,
            "cpu_threads_per_core": 1,
            "credit_specification": [
              {
                "cpu_credits": "standard"
              }
            ],
            "disable_api_termination": false,
            "ebs_block_device": [],
            "ebs_optimized": false,
            "enclave_options": [
              {
                "enabled": false
              }
            ],
            "ephemeral_block_device": [],
            "get_password_data": false,
            "hibernation": false,
            "host_id": null,
            "iam_instance_profile": "opsschool-consul-join",
            "id": "i-0294697b600f3ff41",
            "instance_initiated_shutdown_behavior": "stop",
            "instance_state": "running",
            "instance_type": "t2.micro",
            "ipv6_address_count": 0,
            "ipv6_addresses": [],
            "key_name": "galsekey",
            "launch_template": [],
            "metadata_options": [
              {
                "http_endpoint": "enabled",
                "http_put_response_hop_limit": 1,
                "http_tokens": "optional",
                "instance_metadata_tags": "disabled"
              }
            ],
            "monitoring": false,
            "network_interface": [],
            "outpost_arn": "",
            "password_data": "",
            "placement_group": "",
            "placement_partition_number": null,
            "primary_network_interface_id": "eni-0c435b51426045482",
            "private_dns": "ip-172-31-87-252.ec2.internal",
            "private_ip": "172.31.87.252",
            "public_dns": "ec2-54-86-181-107.compute-1.amazonaws.com",
            "public_ip": "54.86.181.107",
            "root_block_device": [
              {
                "delete_on_termination": true,
                "device_name": "/dev/sda1",
                "encrypted": false,
                "iops": 100,
                "kms_key_id": "",
                "tags": {},
                "throughput": 0,
                "volume_id": "vol-0e721bd629d1e5963",
                "volume_size": 8,
                "volume_type": "gp2"
              }
            ],
            "secondary_private_ips": [],
            "security_groups": [
              "opsschool-consul"
            ],
            "source_dest_check": true,
            "subnet_id": "subnet-0085372b261af5ca2",
            "tags": {
              "Name": "opsschool-client-1"
            },
            "tags_all": {
              "Name": "opsschool-client-1"
            },
            "tenancy": "default",
            "timeouts": null,
            "user_data": "2c2594eb4095be49664b8252998f64ccc9df3a4c",
            "user_data_base64": null,
            "volume_tags": null,
            "vpc_security_group_ids": [
              "sg-0bc59253baa150a17"
            ]
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6MTIwMDAwMDAwMDAwMCwidXBkYXRlIjo2MDAwMDAwMDAwMDB9LCJzY2hlbWFfdmVyc2lvbiI6IjEifQ==",
          "dependencies": [
            "aws_iam_instance_profile.consul-join",
            "aws_iam_role.consul-join",
            "aws_security_group.opsschool_consul",
            "data.template_cloudinit_config.consul_client",
            "data.template_file.consul_client",
            "data.template_file.webserver"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_instance",
      "name": "consul_server",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "index_key": 0,
          "schema_version": 1,
          "attributes": {
            "ami": "ami-04b9e92b5572fa0d1",
            "arn": "arn:aws:ec2:us-east-1:727940474452:instance/i-07bda2c59bd323ee3",
            "associate_public_ip_address": true,
            "availability_zone": "us-east-1b",
            "capacity_reservation_specification": [
              {
                "capacity_reservation_preference": "open",
                "capacity_reservation_target": []
              }
            ],
            "cpu_core_count": 1,
            "cpu_threads_per_core": 1,
            "credit_specification": [
              {
                "cpu_credits": "standard"
              }
            ],
            "disable_api_termination": false,
            "ebs_block_device": [],
            "ebs_optimized": false,
            "enclave_options": [
              {
                "enabled": false
              }
            ],
            "ephemeral_block_device": [],
            "get_password_data": false,
            "hibernation": false,
            "host_id": null,
            "iam_instance_profile": "opsschool-consul-join",
            "id": "i-07bda2c59bd323ee3",
            "instance_initiated_shutdown_behavior": "stop",
            "instance_state": "running",
            "instance_type": "t2.micro",
            "ipv6_address_count": 0,
            "ipv6_addresses": [],
            "key_name": "galsekey",
            "launch_template": [],
            "metadata_options": [
              {
                "http_endpoint": "enabled",
                "http_put_response_hop_limit": 1,
                "http_tokens": "optional",
                "instance_metadata_tags": "disabled"
              }
            ],
            "monitoring": false,
            "network_interface": [],
            "outpost_arn": "",
            "password_data": "",
            "placement_group": "",
            "placement_partition_number": null,
            "primary_network_interface_id": "eni-0a2a64b36ed73876b",
            "private_dns": "ip-172-31-80-23.ec2.internal",
            "private_ip": "172.31.80.23",
            "public_dns": "ec2-52-205-252-79.compute-1.amazonaws.com",
            "public_ip": "52.205.252.79",
            "root_block_device": [
              {
                "delete_on_termination": true,
                "device_name": "/dev/sda1",
                "encrypted": false,
                "iops": 100,
                "kms_key_id": "",
                "tags": {},
                "throughput": 0,
                "volume_id": "vol-08c02e4fd57475df8",
                "volume_size": 8,
                "volume_type": "gp2"
              }
            ],
            "secondary_private_ips": [],
            "security_groups": [
              "opsschool-consul"
            ],
            "source_dest_check": true,
            "subnet_id": "subnet-0085372b261af5ca2",
            "tags": {
              "Name": "opsschool-server-1",
              "consul_server": "true"
            },
            "tags_all": {
              "Name": "opsschool-server-1",
              "consul_server": "true"
            },
            "tenancy": "default",
            "timeouts": null,
            "user_data": "69838b8e5e3225f176f2d504c7ee130361052be3",
            "user_data_base64": null,
            "volume_tags": null,
            "vpc_security_group_ids": [
              "sg-0bc59253baa150a17"
            ]
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6MTIwMDAwMDAwMDAwMCwidXBkYXRlIjo2MDAwMDAwMDAwMDB9LCJzY2hlbWFfdmVyc2lvbiI6IjEifQ==",
          "dependencies": [
            "aws_iam_instance_profile.consul-join",
            "aws_iam_role.consul-join",
            "aws_security_group.opsschool_consul",
            "data.template_file.consul_server"
          ]
        },
        {
          "index_key": 1,
          "schema_version": 1,
          "attributes": {
            "ami": "ami-04b9e92b5572fa0d1",
            "arn": "arn:aws:ec2:us-east-1:727940474452:instance/i-0f592a28eec22c05b",
            "associate_public_ip_address": true,
            "availability_zone": "us-east-1b",
            "capacity_reservation_specification": [
              {
                "capacity_reservation_preference": "open",
                "capacity_reservation_target": []
              }
            ],
            "cpu_core_count": 1,
            "cpu_threads_per_core": 1,
            "credit_specification": [
              {
                "cpu_credits": "standard"
              }
            ],
            "disable_api_termination": false,
            "ebs_block_device": [],
            "ebs_optimized": false,
            "enclave_options": [
              {
                "enabled": false
              }
            ],
            "ephemeral_block_device": [],
            "get_password_data": false,
            "hibernation": false,
            "host_id": null,
            "iam_instance_profile": "opsschool-consul-join",
            "id": "i-0f592a28eec22c05b",
            "instance_initiated_shutdown_behavior": "stop",
            "instance_state": "running",
            "instance_type": "t2.micro",
            "ipv6_address_count": 0,
            "ipv6_addresses": [],
            "key_name": "galsekey",
            "launch_template": [],
            "metadata_options": [
              {
                "http_endpoint": "enabled",
                "http_put_response_hop_limit": 1,
                "http_tokens": "optional",
                "instance_metadata_tags": "disabled"
              }
            ],
            "monitoring": false,
            "network_interface": [],
            "outpost_arn": "",
            "password_data": "",
            "placement_group": "",
            "placement_partition_number": null,
            "primary_network_interface_id": "eni-080e5497851136ddd",
            "private_dns": "ip-172-31-81-221.ec2.internal",
            "private_ip": "172.31.81.221",
            "public_dns": "ec2-18-207-248-124.compute-1.amazonaws.com",
            "public_ip": "18.207.248.124",
            "root_block_device": [
              {
                "delete_on_termination": true,
                "device_name": "/dev/sda1",
                "encrypted": false,
                "iops": 100,
                "kms_key_id": "",
                "tags": {},
                "throughput": 0,
                "volume_id": "vol-0f8a6030dc023e3ea",
                "volume_size": 8,
                "volume_type": "gp2"
              }
            ],
            "secondary_private_ips": [],
            "security_groups": [
              "opsschool-consul"
            ],
            "source_dest_check": true,
            "subnet_id": "subnet-0085372b261af5ca2",
            "tags": {
              "Name": "opsschool-server-2",
              "consul_server": "true"
            },
            "tags_all": {
              "Name": "opsschool-server-2",
              "consul_server": "true"
            },
            "tenancy": "default",
            "timeouts": null,
            "user_data": "a02b9c9e4f3a4900ae751e6a360a8f56bfd28928",
            "user_data_base64": null,
            "volume_tags": null,
            "vpc_security_group_ids": [
              "sg-0bc59253baa150a17"
            ]
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6MTIwMDAwMDAwMDAwMCwidXBkYXRlIjo2MDAwMDAwMDAwMDB9LCJzY2hlbWFfdmVyc2lvbiI6IjEifQ==",
          "dependencies": [
            "aws_iam_role.consul-join",
            "aws_security_group.opsschool_consul",
            "data.template_file.consul_server",
            "aws_iam_instance_profile.consul-join"
          ]
        },
        {
          "index_key": 2,
          "schema_version": 1,
          "attributes": {
            "ami": "ami-04b9e92b5572fa0d1",
            "arn": "arn:aws:ec2:us-east-1:727940474452:instance/i-01aa23d44a466e3e1",
            "associate_public_ip_address": true,
            "availability_zone": "us-east-1b",
            "capacity_reservation_specification": [
              {
                "capacity_reservation_preference": "open",
                "capacity_reservation_target": []
              }
            ],
            "cpu_core_count": 1,
            "cpu_threads_per_core": 1,
            "credit_specification": [
              {
                "cpu_credits": "standard"
              }
            ],
            "disable_api_termination": false,
            "ebs_block_device": [],
            "ebs_optimized": false,
            "enclave_options": [
              {
                "enabled": false
              }
            ],
            "ephemeral_block_device": [],
            "get_password_data": false,
            "hibernation": false,
            "host_id": null,
            "iam_instance_profile": "opsschool-consul-join",
            "id": "i-01aa23d44a466e3e1",
            "instance_initiated_shutdown_behavior": "stop",
            "instance_state": "running",
            "instance_type": "t2.micro",
            "ipv6_address_count": 0,
            "ipv6_addresses": [],
            "key_name": "galsekey",
            "launch_template": [],
            "metadata_options": [
              {
                "http_endpoint": "enabled",
                "http_put_response_hop_limit": 1,
                "http_tokens": "optional",
                "instance_metadata_tags": "disabled"
              }
            ],
            "monitoring": false,
            "network_interface": [],
            "outpost_arn": "",
            "password_data": "",
            "placement_group": "",
            "placement_partition_number": null,
            "primary_network_interface_id": "eni-003f8d1aaf3c87992",
            "private_dns": "ip-172-31-81-165.ec2.internal",
            "private_ip": "172.31.81.165",
            "public_dns": "ec2-54-175-208-63.compute-1.amazonaws.com",
            "public_ip": "54.175.208.63",
            "root_block_device": [
              {
                "delete_on_termination": true,
                "device_name": "/dev/sda1",
                "encrypted": false,
                "iops": 100,
                "kms_key_id": "",
                "tags": {},
                "throughput": 0,
                "volume_id": "vol-0af2c4600634453da",
                "volume_size": 8,
                "volume_type": "gp2"
              }
            ],
            "secondary_private_ips": [],
            "security_groups": [
              "opsschool-consul"
            ],
            "source_dest_check": true,
            "subnet_id": "subnet-0085372b261af5ca2",
            "tags": {
              "Name": "opsschool-server-3",
              "consul_server": "true"
            },
            "tags_all": {
              "Name": "opsschool-server-3",
              "consul_server": "true"
            },
            "tenancy": "default",
            "timeouts": null,
            "user_data": "edc98905841135bb18fc3bbb42bf48cfd6b6492b",
            "user_data_base64": null,
            "volume_tags": null,
            "vpc_security_group_ids": [
              "sg-0bc59253baa150a17"
            ]
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6MTIwMDAwMDAwMDAwMCwidXBkYXRlIjo2MDAwMDAwMDAwMDB9LCJzY2hlbWFfdmVyc2lvbiI6IjEifQ==",
          "dependencies": [
            "aws_iam_instance_profile.consul-join",
            "aws_iam_role.consul-join",
            "aws_security_group.opsschool_consul",
            "data.template_file.consul_server"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_instance",
      "name": "promcol",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "ami": "ami-04b9e92b5572fa0d1",
            "arn": "arn:aws:ec2:us-east-1:727940474452:instance/i-0db64684ed0040472",
            "associate_public_ip_address": true,
            "availability_zone": "us-east-1b",
            "capacity_reservation_specification": [
              {
                "capacity_reservation_preference": "open",
                "capacity_reservation_target": []
              }
            ],
            "cpu_core_count": 1,
            "cpu_threads_per_core": 1,
            "credit_specification": [
              {
                "cpu_credits": "standard"
              }
            ],
            "disable_api_termination": false,
            "ebs_block_device": [],
            "ebs_optimized": false,
            "enclave_options": [
              {
                "enabled": false
              }
            ],
            "ephemeral_block_device": [],
            "get_password_data": false,
            "hibernation": false,
            "host_id": null,
            "iam_instance_profile": "opsschool-consul-join",
            "id": "i-0db64684ed0040472",
            "instance_initiated_shutdown_behavior": "stop",
            "instance_state": "running",
            "instance_type": "t2.micro",
            "ipv6_address_count": 0,
            "ipv6_addresses": [],
            "key_name": "galsekey",
            "launch_template": [],
            "metadata_options": [
              {
                "http_endpoint": "enabled",
                "http_put_response_hop_limit": 1,
                "http_tokens": "optional",
                "instance_metadata_tags": "disabled"
              }
            ],
            "monitoring": false,
            "network_interface": [],
            "outpost_arn": "",
            "password_data": "",
            "placement_group": "",
            "placement_partition_number": null,
            "primary_network_interface_id": "eni-0599fdce2678d4c28",
            "private_dns": "ip-172-31-84-247.ec2.internal",
            "private_ip": "172.31.84.247",
            "public_dns": "ec2-44-201-223-168.compute-1.amazonaws.com",
            "public_ip": "44.201.223.168",
            "root_block_device": [
              {
                "delete_on_termination": true,
                "device_name": "/dev/sda1",
                "encrypted": false,
                "iops": 100,
                "kms_key_id": "",
                "tags": {},
                "throughput": 0,
                "volume_id": "vol-06a690b1e35ba1f05",
                "volume_size": 8,
                "volume_type": "gp2"
              }
            ],
            "secondary_private_ips": [],
            "security_groups": [
              "opsschool-consul"
            ],
            "source_dest_check": true,
            "subnet_id": "subnet-0085372b261af5ca2",
            "tags": {
              "Name": "promcol"
            },
            "tags_all": {
              "Name": "promcol"
            },
            "tenancy": "default",
            "timeouts": null,
            "user_data": "6fc2cc441cb7cacc0f2f316036daca0f4afa19ba",
            "user_data_base64": null,
            "volume_tags": null,
            "vpc_security_group_ids": [
              "sg-0bc59253baa150a17"
            ]
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6MTIwMDAwMDAwMDAwMCwidXBkYXRlIjo2MDAwMDAwMDAwMDB9LCJzY2hlbWFfdmVyc2lvbiI6IjEifQ==",
          "dependencies": [
            "data.template_file.promcol",
            "aws_iam_instance_profile.consul-join",
            "aws_iam_role.consul-join",
            "aws_security_group.opsschool_consul",
            "data.template_cloudinit_config.promcol",
            "data.template_file.consul_promcol"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "aws_security_group",
      "name": "opsschool_consul",
      "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
      "instances": [
        {
          "schema_version": 1,
          "attributes": {
            "arn": "arn:aws:ec2:us-east-1:727940474452:security-group/sg-0bc59253baa150a17",
            "description": "Allow ssh \u0026 consul inbound traffic",
            "egress": [
              {
                "cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "description": "Allow all outside security group",
                "from_port": 0,
                "ipv6_cidr_blocks": [],
                "prefix_list_ids": [],
                "protocol": "-1",
                "security_groups": [],
                "self": false,
                "to_port": 0
              }
            ],
            "id": "sg-0bc59253baa150a17",
            "ingress": [
              {
                "cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "description": "Allow consul UI access from the world",
                "from_port": 8500,
                "ipv6_cidr_blocks": [],
                "prefix_list_ids": [],
                "protocol": "tcp",
                "security_groups": [],
                "self": false,
                "to_port": 8500
              },
              {
                "cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "description": "Allow http from the world",
                "from_port": 80,
                "ipv6_cidr_blocks": [],
                "prefix_list_ids": [],
                "protocol": "tcp",
                "security_groups": [],
                "self": false,
                "to_port": 80
              },
              {
                "cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "description": "Allow prometheus UI access from the world",
                "from_port": 9090,
                "ipv6_cidr_blocks": [],
                "prefix_list_ids": [],
                "protocol": "tcp",
                "security_groups": [],
                "self": false,
                "to_port": 9090
              },
              {
                "cidr_blocks": [
                  "0.0.0.0/0"
                ],
                "description": "Allow ssh from the world",
                "from_port": 22,
                "ipv6_cidr_blocks": [],
                "prefix_list_ids": [],
                "protocol": "tcp",
                "security_groups": [],
                "self": false,
                "to_port": 22
              },
              {
                "cidr_blocks": [],
                "description": "Allow all inside security group",
                "from_port": 0,
                "ipv6_cidr_blocks": [],
                "prefix_list_ids": [],
                "protocol": "-1",
                "security_groups": [],
                "self": true,
                "to_port": 0
              }
            ],
            "name": "opsschool-consul",
            "name_prefix": "",
            "owner_id": "727940474452",
            "revoke_rules_on_delete": false,
            "tags": {},
            "tags_all": {},
            "timeouts": null,
            "vpc_id": "vpc-0845cc5563d94e681"
          },
          "sensitive_attributes": [],
          "private": "eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6OTAwMDAwMDAwMDAwfSwic2NoZW1hX3ZlcnNpb24iOiIxIn0="
        }
      ]
    }
  ]
}
